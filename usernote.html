<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
	<head>
		<!--Meta-->
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		
		<!--Title-->
		<title>Weruchat - Annotation</title>
		
		<!--Scripts-->
		<script type="text/javascript" src="scripts/shared.js"></script>
		<script type="text/javascript" src="scripts/browsercheck.js"></script>
		<script type="text/javascript" src="scripts/emoticons.js"></script>
		<script type="text/javascript" src="scripts/switchStyle.js"></script>
		<script type="text/javascript" src="scripts/jsjac.js"></script>
		<script type="text/javascript">
			<!--
			var srcW, jid;
			function init(){
			    srcW = opener;
			    
			    getArgs();
			    
			    if (typeof(passedArgs['jid']) == 'undefined') 
			        return;
			    
			    jid = passedArgs['jid'];
			    
			    var user = srcW.roster.getUserByJID(jid);
			    if (!user) 
			        return; // unbelievable
			    var titleStr = "Annotations for " + user.name;
			    document.title = titleStr;
			    document.getElementById('title').innerHTML = titleStr;
			    
			    if (srcW.annotations[jid]) 
			        document.getElementById('note').value = srcW.annotations[jid];
			}
			
			function saveNotes(){
			    // save note
			    srcW.annotations[jid] = document.getElementById('note').value;
			    
			    var iq = new JSJaCIQ();
			    iq.setType('set');
			    var query = iq.setQuery('jabber:iq:private');
			    var jNode = query.appendChild(iq.buildNode('storage', {
			        'xmlns': 'storage:rosternotes'
			    }));
			    
			    for (var i in srcW.annotations) {
			        if (typeof(srcW.annotations[i]) != 'string') 
			            continue;
			        if (srcW.annotations[i] != '') {
			            var item = jNode.appendChild(iq.getDoc().createElement('note'));
			            item.setAttribute('jid', i);
			            item.appendChild(iq.getDoc().createTextNode(srcW.annotations[i]));
			        }
			    }
			    srcW.Debug.log(iq.getDoc().xml, 3);
			    srcW.con.send(iq);
			}
			
			onload = init;
			onunload = saveNotes;
			//-->
		</script>
	</head>
	<body>
		<h2 id="title"></h2>
		<textarea id="note" class="large"></textarea>
	</body>
</html>