<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
	<head>
		<!--Meta-->
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		
		<!--Title-->
		<title>Weruchat - Chat History</title>
		
		<!--Scripts-->
		<script type="text/javascript" src="scripts/shared.js"></script>
		<script type="text/javascript" src="scripts/emoticons.js"></script>
		<script type="text/javascript" src="scripts/switchStyle.js"></script>
		<script type="text/javascript" src="scripts/jsjac.js"></script>
		<script type="text/javascript" >
			<!--
			function reloadHistory(iq){
			
			    if (iq && iq.getType != 'result') 
			        srcW.Debug.log(iq.xml(), 1);
			    
			    // clear iframes
			    selected_collection.document.body.innerHTML = '';
			    collections.document.body.innerHTML = '';
			    
			    // get collections
			    var aIQ = new JSJaCIQ();
			    aIQ.setType('get');
			    aIQ.setTo(srcW.loghost);
			    var aNode = aIQ.appendNode('list', {
			        'xmlns': 'http://jabber.org/protocol/archive',
			        'with': jid
			    });
			    srcW.con.send(aIQ, me.handleCollsGet);
			    
			    return false;
			}
			
			function handleCollGet(iq){
			    if (!iq || iq.getType() != 'result') 
			        return;
			    
			    srcW.Debug.log(iq.xml(), 2);
			    
			    var histHTML = '';
			    
			    var aStore = iq.getNode().firstChild;
			    for (var i = 0; i < aStore.childNodes.length; i++) {
			        var aChild = aStore.childNodes.item(i);
			        if (aChild.nodeName == 'to') // message from me
			            histHTML += "<font color=\"blue\">&lt;" + srcW.nick + "&gt;</font> ";
			        else 
			            histHTML += "<font color=\"red\">&lt;" + user.name + "&gt;</font> ";
			        
			        if (aChild.firstChild.firstChild) 
			            histHTML += htmlEnc(aChild.firstChild.firstChild.nodeValue);
			        histHTML += '<br>';
			        continue;
			    }
			    selected_collection.document.body.innerHTML = histHTML;
			}
			
			function handleCollsGet(iq){
			    if (!iq || iq.getType() != 'result') 
			        return;
			    
			    srcW.Debug.log(iq.getDoc().xml, 2);
			    
			    var items = iq.getNode().firstChild.getElementsByTagName('store');
			    
			    var myTable = collections.document.createElement("TABLE");
			    var myTableBody = collections.document.createElement("TBODY");
			    
			    myTable.appendChild(myTableBody);
			    
			    var row, cell, textN;
			    for (var i = 0; i < items.length; i++) {
			    
			        var item = items.item(i);
			        
			        row = collections.document.createElement("TR");
			        row.setAttribute("start", item.getAttribute('start'));
			        myTableBody.appendChild(row);
			        
			        cell = collections.document.createElement("TD");
			        row.appendChild(cell);
			        
			        textN = collections.document.createTextNode(hrTime(item.getAttribute('start')));
			        cell.appendChild(textN);
			        
			    }
			    
			    myTable.setAttribute("id", "myTable");
			    myTable.setAttribute("WIDTH", "100%");
			    myTable.setAttribute("BORDER", "0");
			    myTable.setAttribute("CELLSPACING", "0");
			    myTable.setAttribute("CELLPADDING", "0");
			    myTable.setAttribute("RULES", "rows");
			    
			    // add table
			    collections.document.body.appendChild(myTable);
			    
			    // tell frame about it
			    collections.init();
			}
			
			function deleteHistory(){
			    if (!confirm("Are you sure you want to delete this chat history completely?")) 
			        return;
			    
			    var aIQ = new JSJaCIQ();
			    aIQ.setType('set');
			    aIQ.setTo(srcW.loghost);
			    var aNode = aIQ.appendNode('remove', {
			        'xmlns': 'http://jabber.org/protocol/archive',
			        'with': jid
			    });
			    
			    srcW.Debug.log(aIQ.xml(), 2);
			    
			    me = this;
			    srcW.con.send(aIQ, me.reloadHistory);
			}
			
			var srcW;
			function init(){
			    // determine source window
			    if (opener.top.roster) 
			        srcW = opener.top;
			    if (typeof(srcW) == 'undefined' || !srcW) 
			        return;
			    
			    getArgs();
			    jid = passedArgs['jid'];
			    
			    if (typeof(jid) == 'undefined' || jid == '') {
			        alert("JID is missing.\nAborting...");
			        window.close();
			    }
			    
			    user = srcW.roster.getUserByJID(jid);
			    
			    var dtitle = "Chat history for " + user.name;
			    document.getElementById('title').innerHTML = dtitle;
			    document.title = dtitle;
			    
			    // get collections
			    var aIQ = new JSJaCIQ();
			    aIQ.setType('get');
			    aIQ.setTo(srcW.loghost);
			    var aNode = aIQ.appendNode('list', {
			        'xmlns': 'http://jabber.org/protocol/archive',
			        'with': jid
			    });
			    me = this;
			    srcW.con.send(aIQ, me.handleCollsGet);
			}
			
			function keyPressed(e){
			    if (e.keyCode == 27) 
			        window.close();
			    return true;
			}
			
			onkeydown = keyPressed;
			onload = init;
			//-->
		</script>
		<script for="document" event="onkeydown()" language="JScript">
			<!--
			return keyPressed(window.event);
			//-->
		</script>
	</head>
	<body>
		<h2 id="title"></h2>
		<button onclick="deleteHistory();">Delete</button>
		<button onclick="reloadHistory();">Refresh</button>
		<iframe id="collections" name="collections" src="userhist_collections_iframe.html" scrolling="auto" allowtransparency="yes"></iframe>
		<iframe id="selected_collection" name="selected_collection" src="chat_iframe.html" allowtransparency="yes"></iframe>
	</body>
</html>